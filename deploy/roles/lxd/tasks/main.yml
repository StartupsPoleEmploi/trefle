---
- name: Add admin ssh keys to lxd user
  authorized_key:
    key: "{{ item }}"
    user: "{{ ansible_user }}"
  with_items: "{{ ssh_keys }}"
  become: yes

- name: System requirement
  apt:
    name: "{{ item }}"
  with_items:
    - lxd
    - lxd-client
    # Required for ssh ProxyCommand to work
    - netcat-traditional
  become: yes

# Setting sysctl properties for elasticsearch must be performed on the host:
# containers do not have the permissions to modify the sysctl values
- name: Set sysctl configuration
  copy:
    src: sysctl.conf
    dest: /etc/sysctl.d/98-trefle.conf
  become: yes
  register: sysctl_config

- name: Reload sysctl configuration
  command: sysctl --system
  become: yes
  when: sysctl_config.changed

- name: Allow user to run lxd commands
  user:
    name: "{{ ansible_user }}"
    groups:
      - lxd
    append: yes
  become: yes

- name: Upload configuration
  copy:
    src: lxd.yml
    dest: /tmp/lxd.yml

- name: Configure lxd
  shell: "cat /tmp/lxd.yml | lxd init --preseed"

- import_tasks: lxc.yml
  vars:
    - lxc:
        name: trefle
        volumes:
          - name: shared-trefle
            src: /var/www/trefle
            dst: /var/www/trefle

- import_tasks: lxc.yml
  vars:
    - lxc:
        name: elasticsearch
